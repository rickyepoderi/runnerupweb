<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunnerUpWeb Options Page</title>
    <link rel="stylesheet" href="resources/css/runnerupweb.css">
    <script src="resources/js/jquery-2.1.4.min.js" type="text/javascript"></script>
    <script src="resources/js/runnerupweb.js" type="text/javascript"></script>
    <script type="text/javascript">
      var opts;
      var optDefs;
      var user;
      
      function onLoad() {
          new UserOption(loadDefinitions);
      }
      
      function loadDefinitions(userOptions) {
          // create the user options to render the page
          opts = userOptions;
          opts.setBackgroundImage();
          new UserOption(createOptionForm, true);
          user = new UserInfo('', true, setTitle);
      }
      
      function setTitle(user) {
          $('#title').html("Options for " + user.info.login);
      }
      
      function createOptionForm(userOptionDefinitions) {
          optDefs = userOptionDefinitions;
          flatOpts = opts.flat();
          for (var key in flatOpts) {
              var def = optDefs.get(key);
              if (def) {
                  var div = $("<div>");
                  var label = $("<label>", {id: "key-" + key, class: "large"}).attr('for', "val-" + key);
                  var delImg = $('<img>', {src: 'resources/open-iconic/svg-white/delete.svg', alt: '-'});
                  delImg.click(deleteOption);
                  label.append(key + " ")
                  label.append(delImg);
                  //label.append(" :");
                  div.append(label);
                  var input = $(def);
                  input.attr("id", "val-" + key);
                  input.val(flatOpts[key]);
                  input.attr("class", "short");
                  div.append(input);
                  $("form").append(div);
              }
          }
      }
      
      function goIndex() {
          $(location).attr('href', 'index.html');
      }
      
      function doSave() {
          opts.clear();
          $('#form').find("label[id^='key-']").each(
                  function (index, element) {
                      var name = $(element).attr("id").substring(4);
                      if (name.length > 0) {
                          var value = $('#form').find("*[id='val-" + $(element).attr('id').substring(4) + "']").val();
                          if (value.length > 0) {
                              opts.set(name, value);
                          }
                      }
                  }
          );
          opts.save(goIndex);
      }
      
      function newOption() {
          var select = new SelectDisplay();
          select.show(Object.keys(optDefs.flat()).filter(function(i) {return opts.get(i) === null;}), addNewOption);
      }
      
      function addNewOption(idx, key) {
          var div = $("<div>");
          div.append($("<label>", {id: "key-" + key, class: "large"}).attr('for', "val-" + key).text(key + ":"));
          var def = optDefs.get(key);
          var input = $(def);
          input.attr("id", "val-" + key);
          input.attr("class", "short");
          div.append(input);
          $("form").append(div);
          opts.set(key, "none");
      }
      
      function deleteOption(event) {
          $(event.target).parent().parent().remove();
      }
      
    </script>
</head>
<body onload="onLoad()">
    <div class="main">
        <div class="header">
            <div id="div-menu" class="menu" onclick="showPopupMenu(user)"></div>
            <h1 id="title">Options</h1>
        </div>
        <div class="form">
            <form id="form">
            </form>
            <p class="submit">
                <input id="plusButton" type="button" value="New" onclick="newOption()"/>
                <input type="button" value="Save" onclick="doSave()"/>
            </p>
        </div>
    </div>
</body>
</html>
