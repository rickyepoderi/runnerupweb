<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunnerUpWeb Activity Page</title>
    <link rel="stylesheet" href="resources/leaflet-0.7.5/leaflet.css" />
    <link rel="stylesheet" href="resources/css/runnerupweb.css">
    <script src="resources/js/jquery-2.1.4.min.js" type="text/javascript"></script>
    <script src="resources/leaflet-0.7.5/leaflet.js"></script>
    <script src="resources/js/URI.js" type="text/javascript"></script>
    <script src="resources/js/RGraph4.51/RGraph.common.core.js" type="text/javascript"></script>
    <script src="resources/js/RGraph4.51/RGraph.scatter.js" type="text/javascript"></script>
    <script src="resources/js/RGraph4.51/RGraph.common.dynamic.js" type="text/javascript"></script>
    <script src="resources/js/runnerupweb.js" type="text/javascript"></script>
    <script type="text/javascript">
      // read the id to lookup for the activity
      var id = new URI($(location).attr('href')).search(true).id;
      var act;
      var opts;
      var user;
      
      function onLoad() {
          new UserOption(createActivity);
          user = new UserInfo('', true, null);
      }
      
      function createActivity(userOptions) {
          opts = userOptions;
          opts.setBackgroundImage();
          act = new TCXActivity(id, 'map', opts, drawActivity);
      }
      
      function clickLap(el) {
          var lap = parseInt($(this).find('.magnitude-value').html()) - 1;
          act.switchLap(lap);
      }
      
      function doubleClickLap(el) {
          var lap = parseInt($(this).find('.magnitude-value').html()) - 1;
          var converter = new Converter(opts);
          var lapDiv = $('#ldapdiv' + lap);
          if (lapDiv.find('.magnitude').length === 1) {
              drawMagnitude(lapDiv, act.data.Lap[lap], 'Distance', 'DistanceMeters', converter.getDistanceUnit.bind(converter), '../resources/open-iconic/svg-white/flag.svg', lap);
              drawMagnitude(lapDiv, act.data.Lap[lap], 'Avg. Speed', 'AverageSpeed', converter.getSpeedUnit.bind(converter), '../resources/open-iconic/svg-white/graph.svg', lap);
              drawMagnitude(lapDiv, act.data.Lap[lap], 'Max. Speed', 'MaximumSpeed', converter.getSpeedUnit.bind(converter), '../resources/open-iconic/svg-red/graph.svg', lap);
              drawMagnitude(lapDiv, act.data.Lap[lap], 'Calories', 'Calories', null, '../resources/open-iconic/svg-red/calculator.svg', lap);
              drawMagnitude(lapDiv, act.data.Lap[lap], 'Min. Altitude', 'MinimumAltitude', converter.getAltitudeUnit.bind(converter), '../resources/open-iconic/svg-white/arrow-circle-bottom.svg', lap);
              drawMagnitude(lapDiv, act.data.Lap[lap], 'Max. Altitude', 'MaximumAltitude', converter.getAltitudeUnit.bind(converter), '../resources/open-iconic/svg-red/arrow-circle-top.svg', lap);
              drawMagnitude(lapDiv, act.data.Lap[lap].AverageHeartRateBpm, 'Avg. Heart Rate', 'Value', converter.getHeartRateUnit.bind(converter), '../resources/open-iconic/svg-white/heart.svg', lap);
              drawMagnitude(lapDiv, act.data.Lap[lap].MaximumHeartRateBpm, 'Max. Heart Rate', 'Value', converter.getHeartRateUnit.bind(converter), '../resources/open-iconic/svg-red/heart.svg', lap);
          } else {
              lapDiv.find('.magnitude').slice(1).remove();
          }
      }
      
      function doubleClickLaps() {
          var laps = $('#laps');
          if (laps.is(':hidden')) {
              laps.slideDown('slow');
          } else {
              laps.slideUp('slow');
          }
      }
      
      function scatterOnClick(e, bar) {
          // get the index in the array
          var idx = bar.index;
          // locate the value in the laps
          var lap = act.locateLapByIndex(idx);
          if (lap) {
            act.switchLap(lap, true);
            var track = act.locateTrackByIndex(idx);
            if (track) {
              act.showPopup(track);
            }
          }
      }
      
      function scatter(magnitude, attrArray, coverterMethod, closeMethod) {
          var div = $('#Div' + magnitude);
          if (div.length){
            // the div exists => just remove from the body
            div.remove();
          } else {
            // the div does not exist => add the div 
            var converter = new Converter(opts);
            div = $('<div>', {id: 'Div' + magnitude});
            div.addClass('graphic');
            div.appendTo('body');
            var img = $('<img>', {src: 'resources/open-iconic/svg-white/x.svg'});
            img.click(closeMethod);
            div.append(img);
            var h2 = $('<h2>' + magnitude + '</h2>');
            div.append(h2);
            var canvas = $('<canvas id="Canvas' + magnitude + '" width="' + (div.width()-20) + '" height="300">');
            div.append(canvas);
            var $target = $('html,body'); 
            $target.animate({scrollTop: $target.height()}, 1000);
            // get the array of values
            var data = act.getArray(converter[coverterMethod].bind(converter), attrArray, 
                    opts.getScatterMin(magnitude), opts.getScatterMax(magnitude)); //0.83, 10.0);
            // calculate the labels depending pixels of the canvas and the time
            var min5 = Math.ceil((150 / ((div.width()-20) / parseInt(act.data.TotalTimeSeconds))) / 300.0);
            var labels = [];
            var seconds = 0;
            while (seconds < parseInt(act.data.TotalTimeSeconds)) {
                labels.push([converter.getTime(seconds), seconds*1000]);
                seconds += (300*min5);
            }
            // calculate min and max
            var minmax = [data[0][1], data[0][1]];
            for (var i in data) {
                if (data[i][1] < minmax[0]) {
                    minmax[0] = data[i][1];
                } else if (data[i][1] > minmax[1]) {
                    minmax[1] = data[i][1];
                }
            }
            // draw the scatter
            var scatter = new RGraph.Scatter({
                id: 'Canvas' + magnitude,
                data: data,
                options: {
                    xmin: data[0][0],
                    xmax: data[data.length - 1][0],
                    ymin: minmax[0],
                    ymax: minmax[1],
                    tickmarks: null,
                    lineLinewidth: 2,
                    line: true,
                    lineColors: ['white'],
                    labels: labels,
                    backgroundGridVlines: false,
                    numxticks: 0,
                    textColor: 'white',
                    titleColor: 'white',
                    axisColor: 'white',
                    gutterLeft: 50,
                    eventsClick: scatterOnClick
                }
            }).draw();
          }
      }
      
      function scatterAltitude() {
          scatter('Altitude', ['AltitudeMeters'], 'getAltitude', scatterAltitude);
      }
      
      function scatterHeartRate() {
          scatter('HeartRate', ['HeartRateBpm', 'Value'], 'getHeartRate', scatterHeartRate);
      }
      
      function scatterSpeed() {
          scatter('Speed', ['AverageSpeed'], 'getSpeed', scatterSpeed);
      }
      
      function drawMagnitudeBox(mainDiv, title, value, img, idx, onClick, onDoubleClick) {
          var div = $('<div/>');
          div.addClass('magnitude');
          var divheader = $('<div/>');
          divheader.addClass('magnitude-header');
          divheader.html(title);
          var divvalue = $('<div/>');
          divvalue.addClass('magnitude-value');
          divvalue.append(value);
          var color = '#003366';
          if (typeof idx !== 'undefined' && idx !== null) {
              var color = opts.getActivityLapColor(idx);
              divheader.css('border', color + ' 1px solid');
              divvalue.css('border', color + ' 1px solid');
          }
          if (img) {
              divheader.css('background', color + ' url(' + img + ') 5px center/16px no-repeat');
          }
          div.append(divheader);
          div.append(divvalue);
          if (onClick) {
              div.click(onClick);
              div.css('cursor', 'pointer');
          }
          if (onDoubleClick) {
              div.dblclick(onDoubleClick);
              div.on('doubletap', onDoubleClick);
              div.css('cursor', 'pointer');
          }
          mainDiv.append(div);
      }
      
      function drawMagnitude(mainDiv, container, title, magnitude, converterMethod, url, idx, onClick, onDoubleClick) {
          if (container && container.hasOwnProperty(magnitude) && container[magnitude] != 0) {
              drawMagnitudeBox(mainDiv, title, 
                  converterMethod? converterMethod(container[magnitude]):container[magnitude],
                  url, idx, onClick, onDoubleClick);
          }
      }
      
      function drawActivity(activity) {
          var converter = new Converter(opts);
          $('#title').html(converter.getDateTime(activity.data['Id']));
          var mainDiv = $('#activity-magnitudes');
          // draw all the magnitudes of the activity
          // activity magnitudes
          drawMagnitude(mainDiv, activity.data, 'Sport', 'Sport', null, '../resources/open-iconic/svg-white/pin.svg');
          drawMagnitudeBox(mainDiv, 'Laps', activity.data.Lap.length, '../resources/open-iconic/svg-white/loop.svg', null, null, doubleClickLaps);
          drawMagnitude(mainDiv, activity.data, 'Time', 'TotalTimeSeconds', converter.getTime.bind(converter), '../resources/open-iconic/svg-white/clock.svg');
          drawMagnitude(mainDiv, activity.data, 'Distance', 'DistanceMeters', converter.getDistanceUnit.bind(converter), '../resources/open-iconic/svg-white/flag.svg');
          drawMagnitude(mainDiv, activity.data, 'Avg. Speed', 'AverageSpeed', converter.getSpeedUnit.bind(converter), '../resources/open-iconic/svg-white/graph.svg', null, scatterSpeed, null);
          drawMagnitude(mainDiv, activity.data, 'Max. Speed', 'MaximumSpeed', converter.getSpeedUnit.bind(converter), '../resources/open-iconic/svg-red/graph.svg', null, scatterSpeed, null);
          drawMagnitude(mainDiv, activity.data, 'Calories', 'Calories', null, '../resources/open-iconic/svg-red/calculator.svg');
          drawMagnitude(mainDiv, activity.data, 'Min. Altitude', 'MinimumAltitude', converter.getAltitudeUnit.bind(converter), '../resources/open-iconic/svg-white/arrow-circle-bottom.svg', null, scatterAltitude, null);
          drawMagnitude(mainDiv, activity.data, 'Max. Altitude', 'MaximumAltitude', converter.getAltitudeUnit.bind(converter), '../resources/open-iconic/svg-red/arrow-circle-top.svg', null, scatterAltitude, null);
          drawMagnitude(mainDiv, activity.data, 'Avg. Heart Rate', 'AverageHeartRateBpm', converter.getHeartRateUnit.bind(converter), '../resources/open-iconic/svg-white/heart.svg', null, scatterHeartRate, null);
          drawMagnitude(mainDiv, activity.data, 'Max. Heart Rate', 'MaximumHeartRateBpm', converter.getHeartRateUnit.bind(converter), '../resources/open-iconic/svg-red/heart.svg', null, scatterHeartRate, null);
          // magnitudes for every lap
          for (var i = 0; i < activity.data.Lap.length; i++) {
              var lapDiv = $('<div/>', {id: 'ldapdiv' + i});
              lapDiv.addClass('magnitude-lap-row');
              drawMagnitudeBox(lapDiv, 'Lap', i+1, '../resources/open-iconic/svg-white/loop.svg', i, clickLap, doubleClickLap);
              $('#laps').append(lapDiv);
          }
          activity.prepareMap();
      }
      
      
      /*
      var client = new Client('rpc/json/workout/download.php');
      client.downloadActivity(id, onSuccess, onError);
      var activity;
      var laps;
      var trackpoints;
      var map;
      var polyline;
      var start;
      var end;
      var clickPopup = L.popup();
      
      function toTime(time) {
          // transform to seconds
          time = parseInt(time / 1000);
          var res = '';
          if (time > 60) {
              // check minutes
              if (time > 3600) {
                  // check hours
                  if (time > 86400) {
                      // check days
                      res += parseInt(time / 86400) + 'd';
                      time = time % 86400;
                  }
                  // hours
                  res += parseInt(time / 3600) + 'h';
                  time = time % 3600;
              }
              // minutes
              res += parseInt(time / 60) + 'm';
              time = time % 60;
          }
          res += time + 's';
          return res;
      }
      
      function toKilometers(distance) {
          return (distance / 1000).toFixed(3) + 'Km';
      }
      
      function distance(a, b) {
          return Math.sqrt(Math.pow(b.lat - a.lat, 2) + Math.pow(b.lng - a.lng, 2))
      }
      
      function pointMessage(idx) {
          var message = '<b>Time:</b> ' + toTime(Date.parse(trackpoints[idx].getElementsByTagName('Time')[0].textContent)
                  - Date.parse(activity.getElementsByTagName('Id')[0].textContent));
          message += '<br/><b>Distance:</b> ' + toKilometers(trackpoints[idx].getElementsByTagName('DistanceMeters')[0].textContent);
          message += '<br/><b>Altitude:</b> ' + trackpoints[idx].getElementsByTagName('AltitudeMeters')[0].textContent;
          message += '<br/><b>HeartRate:</b> ' + trackpoints[idx].getElementsByTagName('HeartRateBpm')[0].getElementsByTagName('Value')[0].textContent;
          return message;
      }
      
      function onItineraryClick(e) {
          var min = polyline._latlngs[0];
          var dist = distance(e.latlng, min);
          var idx = 0;
          for (var i = 1; i < polyline._latlngs.length; i++) {
              var d = distance(e.latlng, polyline._latlngs[i]);
              if (d < dist) {
                  idx = i;
                  dist = d;
                  min = polyline._latlngs[i];
              }
          }
          clickPopup.setLatLng(min).setContent(pointMessage(idx)).openOn(map);
      }
      
      function itinerary() {
          // create the start marker
          start = L.marker([
              trackpoints[0].getElementsByTagName('Position')[0].getElementsByTagName('LatitudeDegrees')[0].textContent,
              trackpoints[0].getElementsByTagName('Position')[0].getElementsByTagName('LongitudeDegrees')[0].textContent,
          ]).bindPopup(pointMessage(0)).addTo(map);
          // create the end marker
          end = L.marker([
              trackpoints[trackpoints.length - 1].getElementsByTagName('Position')[0].getElementsByTagName('LatitudeDegrees')[0].textContent,
              trackpoints[trackpoints.length - 1].getElementsByTagName('Position')[0].getElementsByTagName('LongitudeDegrees')[0].textContent,
          ]).bindPopup(pointMessage(trackpoints.length - 1)).addTo(map);
          // create the polyline for the itinerary
          polyline = L.polyline([]);
          for (var i = 0; i < trackpoints.length; i++) {
              polyline.addLatLng([
                  trackpoints[i].getElementsByTagName('Position')[0].getElementsByTagName('LatitudeDegrees')[0].textContent,
                  trackpoints[i].getElementsByTagName('Position')[0].getElementsByTagName('LongitudeDegrees')[0].textContent,
              ]);
          }
          polyline.addTo(map);
          polyline.on('click', onItineraryClick);
          map.fitBounds(polyline.getBounds());
      }
      
      function prepareMap() {
          var x = trackpoints[0].getElementsByTagName('Position')[0].getElementsByTagName('LatitudeDegrees')[0].textContent;
          var y = trackpoints[0].getElementsByTagName('Position')[0].getElementsByTagName('LongitudeDegrees')[0].textContent;
          map = L.map('map').setView([x, y], 17);
          // openstreetmap
          // TODO: set the tile layer => 
          //    http://wiki.openstreetmap.org/wiki/Slippy_map_tilenames
          //    https://gist.github.com/davidkeen/3729820
          var osmAttr = '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';
          L.tileLayer(
              'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: osmAttr,
          }).addTo(map);
          // opencyclemap
          L.tileLayer(
              'http://{s}.tile.opencyclemap.org/cycle/{z}/{x}/{y}.png', {
                  attribution: '&copy; OpenCycleMap, ' + 'Map data ' + osmAttr
	  }).addTo(map);
          // MapQuest
          var mqTilesAttr = 'Tiles &copy; <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" />';
          L.tileLayer(
              'http://otile{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.jpg', {
                  subdomains: '1234',
		  type: 'osm',
                  attribution: 'Map data ' + L.TileLayer.OSM_ATTR + ', ' + mqTilesAttr
	  }).addTo(map);
          // MapQuest Open Aerial (only higher tiles)
          L.tileLayer(
              'http://otile{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.jpg', {
                  subdomains: '1234',
		  type: 'sat',
		  attribution: 'Imagery &copy; NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency, ' + mqTilesAttr
	  }).addTo(map);
      }
      
      function onSuccess(data) {
          activity = data.getElementsByTagName('Activity')[0];
          trackpoints = data.getElementsByTagName('Trackpoint');
          laps = data.getElementsByTagName('Lap');
          // prepare the map
          if (trackpoints && trackpoints.length > 0) {
              prepareMap();
              itinerary();
          }
      }
      
      function onError(data) {
          if (data.status === 403) {
              $(location).attr('href','login.html');
          } else {
              message(data.statusText + ' (' + data.status + ')', 'error');
          }
      }*/
      
    </script>
<body onload="onLoad()">
    <div class="header">
        <div id="div-menu" class="menu" onclick="showPopupMenu(user)"></div>
        <h1 id="title"></h1>
    </div>
    <div id="main">
        <div id="activity-magnitudes" class="magnitude-row"></div>
    </div>
    <div class="laps" id="laps">
        <div class="magnitude-row"></div>
    </div>
    <div id="map" class="map"></div>
</body>
</html>
